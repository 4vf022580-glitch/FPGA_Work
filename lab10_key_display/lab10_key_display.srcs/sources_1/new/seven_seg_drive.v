`timescale 1ns / 1ps

//=============================================================================
// 模块名称：seven_seg_drive
// 功能描述：适用于 Basys3 FPGA 的 4 位数码管动态扫描驱动
//           利用分时复用（Time-Division Multiplexing）技术驱动共阳极数码管
//=============================================================================

module seven_seg_drive(
    input             clk,      // 系统时钟 (Basys3 板载为 100MHz)
    input             rst,      // 系统复位 (高电平有效)
    input      [15:0] data_in,  // 待显示的 16 位数据 (4 个 Hex 字符)
    output reg [3:0]  an,       // 位选信号 (控制哪一位数码管被点亮)
    output reg [6:0]  seg       // 段选信号 (控制显示什么字符 g~a)
);

    //=========================================================================
    // 1. 扫描时钟生成 (Refresh Counter)
    //=========================================================================
    // 目的：将高频系统时钟分频，产生适合人眼观测的扫描频率。
    // 原理：利用视觉暂留效应。
    // 计算：取计数器第 [19:18] 位，刷新周期 = 2^18 * 10ns ≈ 2.62ms。
    //       全屏刷新率 ≈ 1/(2.62ms * 4) ≈ 95Hz，确保人眼无闪烁感。
    
    reg [19:0] refresh_counter;
    wire [1:0] scan_select;

    always @(posedge clk or posedge rst) begin
        if (rst) 
            refresh_counter <= 20'b0;
        else 
            refresh_counter <= refresh_counter + 1'b1;
    end

    // 使用高位 [19:18] 作为 2 位扫描选择信号
    assign scan_select = refresh_counter[19:18];

    //=========================================================================
    // 2. 位选控制与多路复用 (Anode Control)
    //=========================================================================
    // 目的：根据 scan_select 信号，轮流选通 4 个数码管。
    // 硬件特性：Basys3 数码管为共阳极 (Common Anode)，位选信号低电平有效 (0=ON)。
    
    reg [3:0] hex_digit; // 暂存当前选通位对应的 4 位 Hex 数据

    always @(*) begin
        case (scan_select)
            2'b00: begin
                an = 4'b1110;           // 选通第 0 位 (最右侧)
                hex_digit = data_in[3:0];
            end
            2'b01: begin
                an = 4'b1101;           // 选通第 1 位
                hex_digit = data_in[7:4];
            end
            2'b10: begin
                an = 4'b1011;           // 选通第 2 位
                hex_digit = data_in[11:8];
            end
            2'b11: begin
                an = 4'b0111;           // 选通第 3 位 (最左侧)
                hex_digit = data_in[15:12];
            end
            default: begin
                an = 4'b1111;           // 默认关闭所有位 (安全保护)
                hex_digit = 4'b0000;
            end
        endcase
    end

    //=========================================================================
    // 3. 段选译码 (Segment Decoding)
    //=========================================================================
    // 目的：将 4 位二进制数译码为 7 段数码管控制信号。
    // 
    // 映射关系：标准 7 段编码 {g, f, e, d, c, b, a}。
    // 硬件特性：共阳极数码管，段选信号低电平点亮 (0=LED ON)。
    
    always @(*) begin
        case (hex_digit)
            //               gfedcba
            4'h0: seg = 7'b1000000; // 显示 '0'
            4'h1: seg = 7'b1111001; // 显示 '1'
            4'h2: seg = 7'b0100100; // 显示 '2'
            4'h3: seg = 7'b0110000; // 显示 '3'
            4'h4: seg = 7'b0011001; // 显示 '4'
            4'h5: seg = 7'b0010010; // 显示 '5'
            4'h6: seg = 7'b0000010; // 显示 '6'
            4'h7: seg = 7'b1111000; // 显示 '7'
            4'h8: seg = 7'b0000000; // 显示 '8'
            4'h9: seg = 7'b0010000; // 显示 '9'
            4'hA: seg = 7'b0001000; // 显示 'A'
            4'hB: seg = 7'b0000011; // 显示 'b' (小写，区别于 8)
            4'hC: seg = 7'b1000110; // 显示 'C'
            4'hD: seg = 7'b0100001; // 显示 'd' (小写，区别于 0)
            4'hE: seg = 7'b0000110; // 显示 'E'
            4'hF: seg = 7'b0001110; // 显示 'F'
            default: seg = 7'b1111111; // 熄灭所有段
        endcase
    end

endmodule