`timescale 1ns / 1ps

//================================================================================
// Module Name:    tb_top
// Description:    系统级仿真平台 (System Testbench)
//                 模拟 PC 发送 UART 数据，验证顶层模块的接收与回环功能。
//================================================================================

module tb_top();

    //----------------------------------------------------------------------------
    // 1. 信号定义 (Signal Definitions)
    //----------------------------------------------------------------------------
    reg  clk;
    reg  rst_n;    // 低电平复位
    reg  rx_line;  // 模拟 PC TX -> FPGA RX
    wire tx_line;  // 观测 FPGA TX -> PC RX

    //----------------------------------------------------------------------------
    // 2. 待测设备实例化 (DUT Instantiation)
    //----------------------------------------------------------------------------
    top uut (
        .clk     (clk),
        .rst_n   (rst_n),
        .uart_rx (rx_line), // 注意：请确保 top 模块端口名与此处一致
        .uart_tx (tx_line)
    );

    //----------------------------------------------------------------------------
    // 3. 时钟生成 (Clock Generation)
    //----------------------------------------------------------------------------
    // 50MHz 时钟 -> 周期 20ns
    initial begin
        clk = 0;
        forever #10 clk = ~clk; 
    end

    //----------------------------------------------------------------------------
    // 4. 发送模型 (BFM - Bus Functional Model)
    //----------------------------------------------------------------------------
    // 定义波特率参数 (必须与 RTL 保持一致)
    localparam BIT_PERIOD = 1000000000 / 115200; // ns

    // 任务：模拟标准 UART 字节发送 (1 Start + 8 Data + 1 Stop)
    task send_byte(input [7:0] data);
        integer i;
        begin
            // A. 发送起始位 (Start Bit: High -> Low)
            rx_line = 0;
            #(BIT_PERIOD);
            
            // B. 逐位发送数据 (LSB First)
            for (i=0; i<8; i=i+1) begin
                rx_line = data[i];
                #(BIT_PERIOD);
            end
            
            // C. 发送停止位 (Stop Bit: Low -> High)
            rx_line = 1;
            #(BIT_PERIOD);
        end
    endtask

    //----------------------------------------------------------------------------
    // 5. 主测试流程 (Main Test Scenario)
    //----------------------------------------------------------------------------
    initial begin
        // --- 系统初始化 ---
        rst_n   = 0; 
        rx_line = 1; // [关键] 串口空闲态必须为高电平 (Idle High)
        
        // --- 释放复位 ---
        #200;
        rst_n = 1; 
        #200;

        // --- 激励注入 ---
        // 发送测试数据 0x55 (二进制 01010101)
        send_byte(8'h55);

        // --- 响应观测 ---
        // 等待足够长的时间 (约 200us) 让 FPGA 完成接收并回传
        #200000; 
        
        $stop;
    end

endmodule