//================================================================================
// Module Name:    top
// Description:    UART 串口回环系统 (Loopback System)
//                 功能：接收 PC 发来的数据，并立即原样发回。
//                 用途：验证 FPGA 板载串口通信链路是否正常。
//================================================================================

module top(
    input  wire clk,        // 系统时钟 (50MHz)
    input  wire rst_n,      // 低电平复位 (Active Low)
    input  wire uart_rx,    // 外部串口输入 (From PC)
    output wire uart_tx     // 外部串口输出 (To PC)
);

    //----------------------------------------------------------------------------
    // 内部信号互联 (Interconnects)
    //----------------------------------------------------------------------------
    wire [7:0] data_loop;   // 数据通路：连接 RX 的输出与 TX 的输入
    wire       rx_done_sig; // 控制握手：RX 完成信号 -> 触发 TX 发送

    //============================================================================
    // 1. 实例化接收模块 (Receiver Instance)
    //============================================================================
    // 负责将串行输入解调为 8位并行数据
    uart_rx #(
        .CLK_FREQ(50_000_000), // 针对 50MHz 时钟配置分频参数
        .BAUD_RATE(115200)
    ) u_rx (
        .clk      (clk), 
        .rst_n    (rst_n), 
        .rx       (uart_rx),
        .data_out (data_loop),   // 将解调后的数据送上总线
        .done     (rx_done_sig)  // 产生接收完成脉冲
    );

    //============================================================================
    // 2. 实例化发送模块 (Transmitter Instance)
    //============================================================================
    // 收到触发信号后，将总线上的并行数据串行化发出
    uart_tx #(
        .CLK_FREQ(50_000_000), 
        .BAUD_RATE(115200)
    ) u_tx (
        .clk      (clk), 
        .rst_n    (rst_n), 
        .tx       (uart_tx),
        .data_in  (data_loop),   // 读取总线上的数据
        .tx_en    (rx_done_sig), // 握手逻辑：直接用 RX 的完成信号驱动 TX 发送
        
        // 关于 ready 信号：
        // 在简单的回环测试中，我们假设串口发送速度足够快，
        // 或者上位机发送间隔足够大，不会出现“上一个没发完下一个又来了”的情况。
        // 所以这里悬空不接 (Left unconnected)。
        .ready    () 
    );

endmodule