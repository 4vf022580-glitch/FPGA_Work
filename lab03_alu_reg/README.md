# Project Pre-Burn: Day 3 - The Heartbeat of Logic (Sequential Circuits)

> **Date:** 2025-12-29 (Beijing Time)
> **Status:** Mission Accomplished (Simulation Passed)
> **Author:** Future IC Engineer

## 1. 项目概述 (Overview)

本日是《预燃行动》的第三天，也是从“组合逻辑”向“时序逻辑”跨越的关键转折点。
**核心目标**：在电路中引入“时间”的概念。
**战略意义**：

1. **HDLBits 侧**：掌握处理复杂状态匹配 (`casez`) 和消除设计隐患 (No Latches) 的完备性思维。
2. **Vivado 侧**：构建第一级流水线 (Pipeline)。通过引入 D 触发器 (DFF)，让 ALU 的运算受时钟信号 (`clk`) 指挥，不再是不可控的瞬间流动。

## 2. 理论军火库 (HDLBits Knowledge Base)

在今天的训练中，我们解决了 Verilog 组合逻辑设计中的两个核心痛点：

### A. 模糊匹配与优先级 (Priority Encoder)

* **痛点**：普通 `case` 只能精确匹配（如 `101`），无法表达“只要 Bit0 是 1，不管高位是什么”的逻辑。
* **武器**：`casez` (Z-match)。
* **语法**：使用 `?` 或 `z` 代表“无关项 (Don't Care)”。
* `8'b???????1`：最低位为 1，高 7 位忽略。


* **工程铁律**：严禁使用 `casex`（它会掩盖 X 态错误），必须使用 `casez`。

### B. 锁存器隐患 (Avoid Latches)

* **现象**：在组合逻辑 (`always @*`) 中，如果 `if` 没有 `else`，或者 `case` 没有 `default`，综合器会生成 Latch（锁存器）来保持旧值。
* **危害**：产生毛刺，时序无法分析，是同步电路设计的大忌。
* **解决方案**：**“默认赋值法 (Default Assignment)”**。
* 在判断语句之前，先把所有输出赋一个初值（如 `out = 0;`），然后再写 `if/case` 进行覆盖。这样确保任何路径都有明确赋值。



## 3. 模块定义 (Design Specifications)

本项目 `lab03_alu_reg` 采用**层次化设计 (Hierarchical Design)**，模拟了 CPU 执行级的基础结构。

### 子模块 1: `alu.v` (运算单元)

* **类型**：组合逻辑 (Combinational)。
* **功能**：负责“算”。输入变化，结果立刻变化。
* **关键点**：`always @(*)` + `case`。

### 子模块 2: `dff.v` (存储单元)

* **类型**：时序逻辑 (Sequential)。
* **功能**：负责“存”。它是电路的阀门，只在时钟上升沿开启。
* **代码范式**：
```verilog
always @(posedge clk) begin  // 仅在上升沿触发
    if (rst) q <= 0;         // 同步复位
    else     q <= d;         // 非阻塞赋值 <=
end

```



### 顶层模块: `alu_reg.v` (总装)

* **功能**：像接线板一样，将 ALU 的输出 (`res`) 连接到 DFF 的输入 (`d`)。
* **物理架构**：
`Input` -> `ALU` -> `(Wire)` -> `DFF` -> `Output`

## 4. 验证与仿真 (Verification)

### 仿真环境构建 (`tb_alu_reg.v`)

本次验证不再依赖板上 LED，而是完全基于 Vivado Simulator 进行波形分析。

1. **造时钟 (Clock Generation)**：
```verilog
initial begin
    clk = 0;
    forever #5 clk = ~clk; // 10ns 周期，100MHz 频率
end

```


2. **实例化 (Instantiation)**：
* `alu_reg` 的输出端口在 TB 中定义为 `wire`（只读）。
* `alu_reg` 的输入端口在 TB 中定义为 `reg`（驱动）。



### 波形验收标准 (Waveform Checklist)

* **复位检查**：当 `rst=1` 时，无论输入如何变化，`out` 必须死锁在 0。
* **延迟特性 (Latency)**：这是时序电路的灵魂。
* **观察点**：在 `90ns` 处改变输入 `a` 和 `b`。
* **现象**：`out` **没有**立刻变化。
* **结果**：直到 `clk` 的下一个上升沿（黄色竖线）到来，`out` 才更新为计算结果。
* **结论**：DFF 成功拦截了数据，建立了由时钟节拍控制的流水线机制。



## 5. 核心认知升级 (Key Learnings)

1. **赋值符号的铁律**：
* **组合逻辑** (`always @*`) 使用 **`=`** (阻塞赋值)。
* **时序逻辑** (`always @posedge clk`) 必须使用 **`<=`** (非阻塞赋值)。


2. **层次化连接 (Hierarchy)**：
* 模块实例化就像“把芯片插在面包板上”。
* `wire` 是连接芯片引脚的铜线。
* 子模块的端口名（`.clk`）和外部信号名（`(clk)`）虽然通常一样，但物理意义不同（插座 vs 插头）。


3. **完备性思维**：
* 写 `if` 时永远想着 `else`。
* 写 `case` 时永远想着 `default`。
* 硬件没有“保持原样”这种智能，除非你显式地告诉它（生成锁存器）或使用寄存器（DFF）。


4. **先仿真，后上板**：
* 波形图是电路的“心电图”。看不懂波形就烧录板子，等于盲人骑瞎马。



## 6. 顾问评价 (Advisor's Note)

> "Day 3 是一个分水岭。你不仅手写了第一个时序逻辑电路，更重要的是，你学会了编写 Testbench 并‘凭空’制造了时钟。那张输入变化但输出等待时钟的波形图，是你迈入同步数字电路设计大门的第一张门票。记住这种受控的感觉——这就是 CPU 工作的原理。"

---

*Generated by Gemini - Your Brutally Honest Co-pilot*